<!DOCTYPE html>
{% load static %}
<html>
  <head>
    <title>digitNback</title>
    <meta charset="utf-8">
    <script src="{% static 'game/scripts/jspsych.js' %}"></script>
    <script src="{% static 'game/jspsych-6/plugins/jspsych-html-keyboard-response.js' %}"></script>
    <script src="{% static 'game/jspsych-6/plugins/jspsych-html-button-response.js' %}"></script>
    <script src="{% static 'game/jspsych-6/plugins/jspsych-fullscreen.js' %}"></script>
    <link rel="stylesheet" href="{% static 'game/styles/jspsych.css' %}"></link>

    <style>
    .dd{
      text-align: center;
    }
    .back{
      text-align: center;
      height: 200px;
      width: auto;
    }


    </style>
  </head>

<body>
  <script>
//Hanseul task!!
    /* create timeline */
    var timeline = [];

    /* define welcome message trial */



    /* define instructions trial */
    var instructions = {
      type: "html-button-response",
      stimulus: "",
      choices: ["화면에 과일들이 나타납니다." +
          "<p>7아 나타나면 GO 버튼을 <br>최대한 빠르게 터치하세요<br>시작할 준비가 되었으면<br>화면을 터치하세요</p></div><br><br><br><br><br><br>"],
      post_trial_gap: 2000
    };
    timeline.push(instructions);

    /* test trials */

    var test_stimuli1 = [
        { stimulus: '<img src=' + "{% static 'game/images/dnb/1.png' %}>", data: { test_part: 'test', correct_response: ""} },
        { stimulus: '<img src=' + "{% static 'game/images/dnb/3.png' %}>", data: { test_part: 'test', correct_response: ""} },
        { stimulus: '<img src=' + "{% static 'game/images/dnb/5.png' %}>", data: { test_part: 'test', correct_response: ""} },
        { stimulus: '<img src=' + "{% static 'game/images/dnb/3.png' %}>", data: { test_part: 'test', correct_response: ""} },
        { stimulus: '<img src=' + "{% static 'game/images/dnb/4.png' %}>", data: { test_part: 'test', correct_response: ""} },
        { stimulus: '<img src=' + "{% static 'game/images/dnb/7.png' %}>", data: { test_part: 'test', correct_response: "0"} },
        { stimulus: '<img src=' + "{% static 'game/images/dnb/8.png' %}>", data: { test_part: 'test', correct_response: ""} },
        { stimulus: '<img src=' + "{% static 'game/images/dnb/6.png' %}>", data: { test_part: 'test', correct_response: ""} },
        { stimulus: '<img src=' + "{% static 'game/images/dnb/7.png' %}>", data: { test_part: 'test', correct_response: "0"} },
        { stimulus: '<img src=' + "{% static 'game/images/dnb/3.png' %}>", data: { test_part: 'test', correct_response: ""} }
    ];

    var test_stimuli2 = [
      { stimulus: '<img src=' + "{% static 'game/images/dnb/2.png' %}>", data: { test_part: 'test', correct_response: ""} },
      { stimulus: '<img src=' + "{% static 'game/images/dnb/3.png' %}>", data: { test_part: 'test', correct_response: ""} },
      { stimulus: '<img src=' + "{% static 'game/images/dnb/3.png' %}>", data: { test_part: 'test', correct_response: "0"} },
      { stimulus: '<img src=' + "{% static 'game/images/dnb/6.png' %}>", data: { test_part: 'test', correct_response: ""} },
      { stimulus: '<img src=' + "{% static 'game/images/dnb/7.png' %}>", data: { test_part: 'test', correct_response: ""} },
      { stimulus: '<img src=' + "{% static 'game/images/dnb/9.png' %}>", data: { test_part: 'test', correct_response: ""} },
      { stimulus: '<img src=' + "{% static 'game/images/dnb/1.png' %}>", data: { test_part: 'test', correct_response: ""} },
      { stimulus: '<img src=' + "{% static 'game/images/dnb/1.png' %}>", data: { test_part: 'test', correct_response: "0"} },
      { stimulus: '<img src=' + "{% static 'game/images/dnb/7.png' %}>", data: { test_part: 'test', correct_response: ""} },
      { stimulus: '<img src=' + "{% static 'game/images/dnb/8.png' %}>", data: { test_part: 'test', correct_response: ""} }

    ];

    var test_stimuli3 = [
      { stimulus: '<img src=' + "{% static 'game/images/dnb/1.png' %}>", data: { test_part: 'test', correct_response: ""} },
      { stimulus: '<img src=' + "{% static 'game/images/dnb/5.png' %}>", data: { test_part: 'test', correct_response: ""} },
      { stimulus: '<img src=' + "{% static 'game/images/dnb/1.png' %}>", data: { test_part: 'test', correct_response: "0"} },
      { stimulus: '<img src=' + "{% static 'game/images/dnb/3.png' %}>", data: { test_part: 'test', correct_response: ""} },
      { stimulus: '<img src=' + "{% static 'game/images/dnb/4.png' %}>", data: { test_part: 'test', correct_response: ""} },
      { stimulus: '<img src=' + "{% static 'game/images/dnb/3.png' %}>", data: { test_part: 'test', correct_response: "0"} },
      { stimulus: '<img src=' + "{% static 'game/images/dnb/7.png' %}>", data: { test_part: 'test', correct_response: ""} },
      { stimulus: '<img src=' + "{% static 'game/images/dnb/8.png' %}>", data: { test_part: 'test', correct_response: ""} },
      { stimulus: '<img src=' + "{% static 'game/images/dnb/9.png' %}>", data: { test_part: 'test', correct_response: ""} },
      { stimulus: '<img src=' + "{% static 'game/images/dnb/8.png' %}>", data: { test_part: 'test', correct_response: "0"} }

    ];

    var fixation = {
      type: 'html-keyboard-response',
      stimulus: '<div style="font-size:60px;"><img src= ' + "{% static 'game/images/fix.png' %}" + '></div>',
      choices: jsPsych.NO_KEYS,
      trial_duration: function(){
        return jsPsych.randomization.sampleWithoutReplacement([1500], 1)[0];
      },
      data: {test_part: 'fixation'}
    }

    var test = {
      type: "html-button-response",
      stimulus: jsPsych.timelineVariable('stimulus'),
      choices: ["GO"],
      data: jsPsych.timelineVariable('data'),
      on_finish: function(data){
        data.correct = data.button_pressed == data.correct_response;
      },
    }

    var test_procedure1 = {
      timeline: [fixation, test],
      timeline_variables: test_stimuli1,
      repetitions: 2,
      randomize_order: false,
      trial_duration: 2000
    }
    timeline.push(test_procedure1);


    var instructions2 = {
      type: "html-button-response",
      stimulus: "",
      choices: ["<p>화면에 나타나는 숫자가 <br>바로 전 순서에 나타났던 숫자와 같을 경우에만 <br>GO버튼을 터치하세요<br>"],
      post_trial_gap: 2000

    };
    timeline.push(instructions2);

    var test_procedure2 = {
      timeline: [fixation, test],
      timeline_variables: test_stimuli2,
      repetitions: 2,
      randomize_order: false,
      trial_duration: 2000
    }
    timeline.push(test_procedure2);

    var instructions3 = {
      type: "html-button-response",
      stimulus: "",
      choices: ["<p>전전 순서에 나타났던 순서와 같으면 <br>GO 버튼을 터치하세요</p><br>"],
      post_trial_gap: 2000
    };
    timeline.push(instructions3);

    var test_procedure3 = {
      timeline: [fixation, test],
      timeline_variables: test_stimuli3,
      repetitions: 2,
      randomize_order: false,
      trial_duration: 2000
    }
    timeline.push(test_procedure3);

    /* define debrief */

    var debrief_block = {
      type: "html-keyboard-response",
      trial_duration: 5000,
      stimulus: function() {

        var trials = jsPsych.data.get().filter({test_part: 'test'});
        var correct_trials = trials.filter({correct: true});
        var accuracy = Math.round(correct_trials.count() / trials.count() * 100);
        var rt = trials.select('rt').mean();
        
        var sum = 0;
        var num = 0;
        for(var i = 0; i < rt.length; i++) {
          if(rt[i] === '') {
            rt[i] = 0;
          }
          else {
            num++;
          }
          sum += rt[i];
        }
        var avg_rt = sum / num;
        
        //var all_data = jsPsych.data.get();
        //console.log(jsPsych.data.get().csv());

        // send the score using POST
        var xhr = new XMLHttpRequest();
        xhr.open("POST", '/game/digitnback/', true);

        //Send the proper header information along with the request
        xhr.setRequestHeader("Content-type", "application/json");

        xhr.onreadystatechange = function () {//Call a function when the state changes.
            if (xhr.readyState == XMLHttpRequest.DONE && xhr.status == 200) {
                // Request finished. Do processing here.
            }
        }

        //xhr.send(JSON.stringify(String(accuracy) + ' ' + String(avg_rt)));
        xhr.send((String(accuracy) + ' ' + String(rt)));

        setTimeout(function () { window.location.replace("/game/digitnback/game-result"); }, 1000);

        /*
        return "<p>You responded correctly on "+accuracy+"% of the trials.</p>"+
        "<p>Your average response time was "+avg_rt+"ms.</p>"+
        "<p>Press any key to complete the experiment. Thank you!</p>";
        */
      }
    };
    timeline.push(debrief_block);


    /* start the experiment */
    jsPsych.init({
      timeline: timeline,
      show_preload_progress_bar: true,
      on_finish: function() {
        //jsPsych.data.get().localSave('csv','digitnbackdata.csv');
        //jsPsych.data.displayData('csv');
      }
    });
  </script>



  </body>


</html>
